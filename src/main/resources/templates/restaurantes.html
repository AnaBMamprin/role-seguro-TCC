<!DOCTYPE html>
<html lang="pt-BR"
	xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCHOMP Restaurantes</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}"> <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

    <style>
        /* Garante que o .menu-card funcione com stretched-link e position absolute */
        .menu-card {
            position: relative;
            /* Adicione aqui seus outros estilos para o card (padding, background, border-radius, etc.) */
            display: flex; /* Para usar mt-auto no form */
            flex-direction: column; /* Para usar mt-auto no form */
            height: 100%; /* Para que mt-auto funcione bem em grids */
        }
        /* Defina o layout do seu grid aqui ou no style.css */
    </style>
</head>
<body>
	<nav class="navbar navbar-expand-lg main-navbar">
			      <div class="container-fluid">
			        <a class="navbar-brand text-white fw-bold" href="/inicial">TCHOMP</a>
			           <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
			             <span class="navbar-toggler-icon"></span>
			           </button>
			        <div class="collapse navbar-collapse justify-content-center" id="navbarMain">
			          <div class="navbar-nav mx-auto d-flex justify-content-center">
			            <a class="nav-link" th:href="@{/inicial}">P√°gina Inicial</a>
			            <a class="nav-link" th:href="@{/restaurantes}">Restaurantes</a>
						<a class="nav-link" th:href="@{/perfil}" sec:authorize="isAuthenticated()">Perfil</a>
						<a class="nav-link" th:href="@{/adm}" sec:authorize="hasRole('ADMIN')">Administra√ß√£o</a>
						<a class="nav-link" th:href="@{/sobre}">Sobre</a>
			          </div>
					  
					  <a th:href="@{/favoritos}" class="btn btn-favorite ms-3" sec:authorize="isAuthenticated()">
					  		<i class="bi bi-heart me-1"></i> Favoritos
					  </a>
					  
			          <form class="d-flex ms-3 search-box" th:action="@{/buscar}" method="get">
			            <input class="form-control" type="search" placeholder="Buscar..." aria-label="Search" name="q">
			            <button class="btn btn-search" type="submit">
			              <i class="bi bi-search"></i>
			            </button>
			          </form>
					  <a href="/logout" class="btn btn-logout ms-3" sec:authorize="isAuthenticated()">
					     <i class="bi bi-box-arrow-right me-1"></i> Sair
					  </a>
					  <a href="/login" class="btn btn-light ms-3 fw-bold" sec:authorize="!isAuthenticated()">
					  	<i class="bi bi-person-circle me-1"></i> Entrar
					  </a>
			        </div>
			      </div>
			    </nav>
    <div style="color: grey;" class="container my-5">  				
		<div class="container mt-4" th:if="${termoBusca != null}">
				    <h3>
				        <i class="bi bi-search me-2 text-muted"></i>
				        Resultados para: "<span class="fw-bold text-primary" th:text="${termoBusca}"></span>"
				    </h3>
				    <a th:href="@{/restaurantes}" class="btn btn-sm btn-outline-secondary mt-2">
				        <i class="bi bi-x-circle"></i> Limpar busca
				    </a>
				</div>

				<div class="container my-5" th:unless="${termoBusca != null}">
				    <h1 class="mb-4">Melhores Localiza√ß√µes</h1>
				    </div>

		<form th:action="@{/restaurantes}" method="GET" class="card shadow-sm mb-4">
		    <div class="card-body">
		        <div class="row g-3 align-items-end">
		            
		            <div class="col-md-4">
		                <label for="culinaria" class="form-label">Filtrar por Culin√°ria:</label>
		                <select id="culinaria" name="culinaria" class="form-select">
		                    <option value="">Todas as Culin√°rias</option>
		                    <option th:each="c : ${culinariasUnicas}" 
		                            th:value="${c}" 
		                            th:text="${c}"
		                            th:selected="${c == culinariaSelecionada}">
		                    </option>
		                </select>
		            </div>
		            
		            <div class="col-md-4">
		                <label for="tipoDePrato" class="form-label">Filtrar por Tipo de Prato:</label>
		                <select id="tipoDePrato" name="tipoDePrato" class="form-select">
		                    <option value="">Todos os Tipos</option>
		                    <option th:each="t : ${tiposDePratoUnicos}" 
		                            th:value="${t}" 
		                            th:text="${t}"
		                            th:selected="${t == tipoDePratoSelecionado}">
		                    </option>
		                </select>
		            </div>
		            
					<div class="col-md-2">
					    <label for="sortParam" class="form-label">Ordenar por:</label>
					    <select id="sortParam" name="sortParam" class="form-select">
					        
					        <option value="nome,ASC" 
					                th:selected="${sortParam == 'nome,ASC'}">
					            Alfab√©tica (A-Z)
					        </option>
					        
					        <option value="nome,DESC" 
					                th:selected="${sortParam == 'nome,DESC'}">
					            Alfab√©tica (Z-A)
					        </option>
					        
					    </select>
					</div>
		            
		            <div class="col-md-2">
		                <button type="submit" class="btn btn-primary w-100">
		                    <i class="bi bi-search me-1"></i> Filtrar
		                </button>
		            </div>
		            
		        </div>
		    </div>
		</form>
		
		<div th:if="${paginaRestaurantes == null or paginaRestaurantes.isEmpty()}" class="alert alert-warning" role="alert">
		    Nenhum restaurante cadastrado ainda.
		</div>

		<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" th:unless="${paginaRestaurantes == null or paginaRestaurantes.isEmpty()}">
		    
		    <div class="col" th:each="restaurante : ${paginaRestaurantes.content}">
		        
		        <div class="menu-card h-100"> 
		            
		            <h3 class="mb-3 fs-2">
		                <a th:href="@{/modelo-restaurante(id=${restaurante.id})}"
		                   class="stretched-link text-decoration-none" style="color: inherit;"
		                   th:text="${restaurante.nome}"> Nome </a>
		            </h3>
		            
		            <span class="favorite-icon" style="position: absolute; top: 15px; right: 15px; z-index: 10; cursor: pointer;"
		                  th:attr="onclick='toggleFavorito(this, ' + ${restaurante.id} + ')'"
		                  th:title="${#sets.contains(idsFavoritos, restaurante.id) ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos'}">
					<i class="bi fs-4" th:classappend="${#sets.contains(idsFavoritos, restaurante.id) ? 'bi-heart-fill coracao-favorito' : 'bi-heart'}"></i>		            </span>

					<div class="d-flex mt-2 flex-grow-1">
					    
					    <div class="flex-grow-1">
					        <p class="mb-1 fs-5"><strong>Cidade:</strong> <span th:text="${restaurante.cidade ?: 'N/A'}"></span></p>
					        <p class="mb-1 fs-5"><strong>Culin√°ria:</strong> <span th:text="${restaurante.culinaria ?: 'N/A'}"></span></p>
					        <p class="mb-1 fs-5"><strong>Tipo:</strong> <span th:text="${restaurante.tipodeprato ?: 'N/A'}"></span></p>
					        <p class="mb-1 fs-5"><strong>Hor√°rio:</strong> <span th:text="${restaurante.horario ?: 'N/A'}"></span></p>
					        <p class="mb-1 fs-5"><strong>Endere√ßo:</strong> <span th:text="${restaurante.endereco ?: 'N/A'}"></span></p>
					    </div>
					    
						<div class="ps-2 text-center">
						    <span th:with="media=${mapaDeMedias.get(restaurante.id)}, 
						                   contagem=${mapaDeContagem.get(restaurante.id)}">
						        
						        <span th:if="${media == null}" class="badge bg-secondary text-dark-emphasis">
						            <i class="bi bi-star"></i> N/A (0)
						        </span>
						        
						        <span th:if="${media != null}" 
						              class="badge bg-dark text-white fs-6">
						            
						            <i class="bi bi-star-fill" style="color: var(--cor-acento);"></i>
						            
						            <span th:text="${#numbers.formatDecimal(media, 1, 1)}"></span>
						            
						            <span class="fw-light" th:text="'(' + ${contagem} + ')'"></span>
						        </span>
						    </span>
						</div>
					    
					</div>
		            
		     <!--        <form th:action="@{/cupons/gerar}" method="post" class="mt-auto pt-3" style="position: relative; z-index: 5;">
		                <input type="hidden" name="restauranteId" th:value="${restaurante.id}" />
		                <button type="submit" class="btn btn-sm btn-success w-100">Gerar Cupom</button>
		            </form> -->   
		     
		    </div> 
			</div> 
			</div>
				<nav aria-label="Navega√ß√£o das p√°ginas" class="mt-5" 
					th:if="${paginaRestaurantes != null AND !paginaRestaurantes.isEmpty() AND paginaRestaurantes.totalPages > 1}">
					
						<ul class="pagination justify-content-center">
						
				        <li class="page-item" th:classappend="${paginaRestaurantes.first ? 'disabled' : ''}">
				            <a class="page-link" 
				               th:href="@{/restaurantes(page=${paginaRestaurantes.number - 1}, culinaria=${culinaria})}">
				               Anterior
				            </a>
				        </li>

				        <li class="page-item disabled">
				            <a class="page-link" href="#">
				                P√°gina <span th:text="${paginaRestaurantes.number + 1}"></span> de 
				                <span th:text="${paginaRestaurantes.totalPages}"></span>
				            </a>
				        </li>

				        <li class="page-item" th:classappend="${paginaRestaurantes.last ? 'disabled' : ''}">
				            <a class="page-link" 
				               th:href="@{/restaurantes(page=${paginaRestaurantes.number + 1}, culinaria=${culinaria})}">
				               Pr√≥ximo
				            </a>
				        </li>

				    </ul>
				</nav>
			</div> <div class="modal fade" id="cupomModal" tabindex="-1">
	    <div class="modal-dialog modal-dialog-centered">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title">Seu Cupom</h5>
	          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	        </div>
	        <div class="modal-body">
	          <p th:if="${cupom != null}">
	            üéâ Cupom gerado com sucesso! <br>
	            C√≥digo: <strong th:text="${cupom.codigo}"></strong><br>
	            Desconto: <span th:text="${cupom.desconto}"></span>%
	          </p>
	          <p th:if="${erro != null}" class="text-danger" th:text="${erro}"></p>
	        </div>
	      </div>
	    </div>
    </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
	<script th:if="${cupom != null or erro != null}">
	    var modal = new bootstrap.Modal(document.getElementById('cupomModal'));
	    modal.show();
	</script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		async function toggleFavorito(element, restauranteId) {
            const icon = element.querySelector('i');
            const isFavorito = icon.classList.contains('bi-heart-fill');
		    const url = isFavorito ? '/favoritos/remove' : '/favoritos/add';
		    const method = 'POST';
		    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
		    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
		    const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
		    if (csrfToken && csrfHeader) { headers[csrfHeader] = csrfToken; }

		    try {
		        const response = await fetch(url, { method: method, headers: headers, body: `restauranteId=${restauranteId}` });
		        if (response.ok) {
		            if (isFavorito) {
		                icon.classList.remove('bi-heart-fill', 'text-danger');
		                icon.classList.add('bi-heart');
		                element.setAttribute('title', 'Adicionar aos Favoritos');
		            } else {
		                icon.classList.remove('bi-heart');
		                icon.classList.add('bi-heart-fill', 'text-danger');
		                element.setAttribute('title', 'Remover dos Favoritos');
		            }
                    // Remove o card APENAS se estiver na p√°gina /favoritos
                    if (window.location.pathname === '/favoritos' && isFavorito) {
                        const cardElement = element.closest('.menu-card');
                        if (cardElement) cardElement.remove();
                    }
		        } else {
		            const errorMsg = await response.text(); alert(`Erro: ${errorMsg}`);
		            if (response.status === 401 || response.status === 403) { window.location.href = '/login'; }
		        }
		    } catch (error) { console.error('Erro:', error); alert('Erro de conex√£o.'); }
		}
		/*]]>*/
	</script>

</body>
</html>