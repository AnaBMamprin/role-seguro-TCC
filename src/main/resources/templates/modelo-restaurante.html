<!DOCTYPE html>
<html lang="pt-BR" 
	xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
	<head>
	  <meta charset="UTF-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	  <title>TCHOMP Restaurante</title>
	
	  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
	  <link rel="stylesheet" th:href="@{/css/style.css}">
	
	  <style>
	    #mapa {
	      height: 400px; 
	      width: 100%;
          background-color: #EEEEEE; /* Um fundo cinza caso o mapa falhe */
	    }
	  </style>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg main-navbar">
		      <div class="container-fluid">
		        <a class="navbar-brand text-white fw-bold" href="/inicial">TCHOMP</a>
		           <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
		             <span class="navbar-toggler-icon"></span>
		           </button>
		        <div class="collapse navbar-collapse justify-content-center" id="navbarMain">
		          <div class="navbar-nav mx-auto d-flex justify-content-center">
		            <a class="nav-link" th:href="@{/inicial}">Página Inicial</a>
		            <a class="nav-link" th:href="@{/restaurantes}">Restaurantes</a>
		            <a class="nav-link" th:href="@{/perfil}">Perfil</a>
		            <a class="nav-link" th:href="@{/adm}" sec:authorize="hasRole('ADMIN')">Administração</a>
		            <a class="nav-link" th:href="@{/sobre}">Sobre</a>
		          </div>
		          <a th:href="@{/favoritos}" class="btn btn-favorite ms-3">
		              <i class="bi bi-heart me-1"></i> Favoritos
		          </a>
		          <form class="d-flex ms-3 search-box" th:action="@{/buscar}" method="get">
		            <input class="form-control" type="search" placeholder="Buscar..." aria-label="Search" name="q">
		            <button class="btn btn-search" type="submit">
		              <i class="bi bi-search"></i>
		            </button>
		          </form>
		          <a href="/logout" class="btn btn-logout ms-3">
		              <i class="bi bi-box-arrow-right me-1"></i> Sair
		          </a>
		        </div>
		      </div>
		    </nav>

			<div class="container my-5 restaurante-detalhes">
			    <div class="row g-4 mb-5">
		       	 <div class="col-md-7 mb-4 mb-md-0">
		            <div class="d-flex align-items-center mb-3">
		                <h1 th:text="${restaurante.nome}" class="me-3 display-5">Nome</h1>
		                
	                    <span class="favorite-icon fs-2" style="cursor: pointer;"
		                      th:attr="onclick='toggleFavorito(this, ' + ${restaurante.id} + ')'"
		                      th:title="${isFavorito ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos'}">
		                    <i class="bi" th:classappend="${isFavorito ? 'bi-heart-fill text-danger' : 'bi-heart'}"></i>
		                </span>
		            </div>
		            <p><strong>Cidade:</strong> <span th:text="${restaurante.cidade ?: 'Não informado'}"></span></p>
		            <p><strong>Culinária:</strong> <span th:text="${restaurante.culinaria ?: 'Não informado'}"></span></p>
		            <p><strong>Tipo de prato:</strong> <span th:text="${restaurante.tipodeprato ?: 'Não informado'}"></span></p>
		            <p><strong>Horário:</strong> <span th:text="${restaurante.horario ?: 'Não informado'}"></span></p>
		            <p><strong>Endereço:</strong> <span th:text="${restaurante.endereco ?: 'Não informado'}"></span></p>
		            <p><strong>Site:</strong>
		                <a th:href="${restaurante.site ?: '#'}" th:text="${restaurante.site ?: 'Não disponível'}" target="_blank" th:if="${restaurante.site != null and !restaurante.site.isEmpty()}"></a>
		                <span th:unless="${restaurante.site != null and !restaurante.site.isEmpty()}">Não disponível</span>
		            </p>
					<div sec:authorize="isAuthenticated()" class="alert alert-info mt-4" role="alert">
					    <h4 class="alert-heading">Deixe sua Avaliação!</h4>
					    <p>Gostou da sua experiência neste restaurante? Compartilhe sua opinião com outros usuários!</p>
					    <hr>
					    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#avaliacaoModal">
					      Avaliar este Restaurante
					    </button>
					</div>		        </div>
		        <div class="col-md-5">
					<img th:if="${restaurante.caminhoFoto != null AND restaurante.caminhoFoto != ''}"
					         th:src="@{/uploads/restaurante-fotos/{filename}(filename=${restaurante.caminhoFoto})}"
					         th:alt="${'Foto de ' + restaurante.nome}"
					         class="img-fluid rounded shadow-sm w-100 mb-3" 
					         style="object-fit: cover; height: 350px; border: 3px solid white;">

					    <div th:if="${restaurante.caminhoFoto == null OR restaurante.caminhoFoto == ''}"
					         class="d-flex align-items-center justify-content-center bg-light rounded shadow-sm w-100 mb-3"
					         style="height: 350px;">
					        <span class="text-muted fs-4">Sem foto</span>
					    </div>

					        <div id="mapa" style="height: 400px; width: 100%;"></div>
		        </div>
		    </div>
		    <div class="mt-5">...</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script th:inline="javascript">
		    /*<![CDATA[*/
		    
		    // ===================================
		    // VARIÁVEIS DO MAPA (DO SEU CÓDIGO)
		    // ===================================
		    const restauranteLat = /*[[${restaurante.latitude}]]*/ 0;
		    const restauranteLng = /*[[${restaurante.longitude}]]*/ 0;
		    const restauranteNome = /*[[${restaurante.nome}]]*/ "Restaurante";

		    // ===================================
		    // FUNÇÃO TOGGLE FAVORITO (COPIADA E SEM CSRF)
		    // ===================================
		    async function toggleFavorito(element, restauranteId) {
		        const icon = element.querySelector('i');
		        const isFavorito = icon.classList.contains('bi-heart-fill');
		        const url = isFavorito ? '/favoritos/remove' : '/favoritos/add';
		        const method = 'POST';
		        
		        // Headers simplificados, sem CSRF
		        const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };

		        try {
		            const response = await fetch(url, { method: method, headers: headers, body: `restauranteId=${restauranteId}` });
		            if (response.ok) {
		                if (isFavorito) {
		                    icon.classList.remove('bi-heart-fill', 'text-danger');
		                    icon.classList.add('bi-heart');
		                    element.setAttribute('title', 'Adicionar aos Favoritos');
		                } else {
		                    icon.classList.remove('bi-heart');
		                    icon.classList.add('bi-heart-fill', 'text-danger');
		                    element.setAttribute('title', 'Remover dos Favoritos');
		                }
		            } else {
		                const errorMsg = await response.text(); alert(`Erro: ${errorMsg}`);
		                if (response.status === 401 || response.status === 403) { window.location.href = '/login'; }
		            }
		        } catch (error) { console.error('Erro:', error); alert('Erro de conexão.'); }
		    }
		    
		    /*]]>*/
		</script>

		<script>
		    function initMap() {
		        // ... (toda a sua lógica do initMap) ...
		    }
		</script>

		<script async
		    th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&callback=initMap'}">
		</script>

			<script>
					        // Esta função é chamada pela API do Google (callback=initMap)
					        function initMap() {
					            
			                    // 1. VERIFICA SE AS COORDENADAS SÃO VÁLIDAS
			                    // (restauranteLat e restauranteLng vêm do script th:inline)
								if (restauranteLat == 0 || restauranteLng == 0) {
								                        
											            // 2. SE FOREM 0, MOSTRE A MENSAGEM
											            const mapaDiv = document.getElementById("mapa");
											            mapaDiv.innerHTML = '<div class="alert alert-warning h-100 d-flex align-items-center justify-content-center">Localização não disponível no mapa.</div>';
											            
											            // 3. NÃO TENTA CRIAR O MAPA
											            return; 
											        }
								                    // --- FIM DA CORREÇÃO ---

											        // 4. SE AS COORDENADAS EXISTIREM (NÃO FOREM 0), CRIA O MAPA
											        const localizacao = { lat: restauranteLat, lng: restauranteLng };

											        const map = new google.maps.Map(document.getElementById("mapa"), {
											            zoom: 16, 
											            center: localizacao,
											        });

											        const marker = new google.maps.Marker({
											            position: localizacao,
											            map: map,
											            title: restauranteNome,
											        });
											    }
					    </script>

		    <script async
		        th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&callback=initMap'}">
		    </script>
			
			<div class="modal fade" id="avaliacaoModal" tabindex="-1" aria-labelledby="avaliacaoModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
			    
			    <form th:action="@{/restaurantes/salvar}" 
			          th:object="${novaAvaliacao}" 
			          method="post" 
			          class="modal-content">
			      
			      <div class="modal-header">
			        <h5 class="modal-title" id="avaliacaoModalLabel">
			            Avalie: <span th:text="${restaurante.nome}"></span>
			        </h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      </div>
			      
			      <div class="modal-body">
			        
			        <div class="mb-3">
			          <label for="tituloAvaliacao" class="form-label">Título da sua avaliação</label>
			          <input type="text" class="form-control" id="tituloAvaliacao" 
			                 th:field="*{tituloAvaliação}" required>
			        </div>
			        
			        <div class="mb-3">
			          <label for="textoAvaliacao" class="form-label">Sua avaliação</label>
			          <textarea class="form-control" id="textoAvaliacao" rows="4" 
			                    th:field="*{textoAvaliação}" required></textarea>
			        </div>
			        
			        <div class="mb-3">
			          <label for="notaAvaliacao" class="form-label">Sua nota</label>
			          <select class="form-select" id="notaAvaliacao" th:field="*{nota}" required>
			            <option value="" disabled selected>Selecione uma nota...</option>
			            <option value="5">⭐⭐⭐⭐⭐ (Excelente)</option>
			            <option value="4">⭐⭐⭐⭐ (Bom)</option>
			            <option value="3">⭐⭐⭐ (Regular)</option>
			            <option value="2">⭐⭐ (Ruim)</option>
			            <option value="1">⭐ (Péssimo)</option>
			          </select>
			        </div>
			        
			        <input type="hidden" name="restauranteId" th:value="${restaurante.id}" />
			        
			      </div>
			      
			      <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
			        <button type="submit" class="btn btn-primary">Enviar Avaliação</button>
			      </div>
			      
			    </form> </div>
			</div>
			

	</body>
	</html>