<!DOCTYPE html>
<html lang="pt-BR" 
	xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tchomp Administração</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<!-- Navbar Principal -->
			    <nav class="navbar navbar-expand-lg main-navbar">
			      <div class="container-fluid">
					
					<!-- LOGO -->
					   <a class="navbar-brand text-white fw-bold" href="/inicial">TCHOMP</a>

					   <!-- BOTÃO TOGGLER (MOBILE) -->
					   <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
					     <span class="navbar-toggler-icon"></span>
					   </button>

			        <!-- Links centralizados + barra de pesquisa -->
			        <div class="collapse navbar-collapse justify-content-center" id="navbarMain">
			          <div class="navbar-nav mx-auto d-flex justify-content-center">
			            <a class="nav-link" th:href="@{/inicial}">Página Inicial</a>
			            <a class="nav-link" th:href="@{/restaurantes}">Restaurantes</a>
			            <a class="nav-link" th:href="@{/perfil}">Perfil</a>
						<!-- Só aparece se o usuário tiver ROLE_ADMIN -->
						<a class="nav-link" th:href="@{/adm}" sec:authorize="hasRole('ADMIN')">Administração</a>
			            <a class="nav-link" th:href="@{/sobre}">Sobre</a>
			          </div>
					  
					  <!-- Botão Favoritos -->
					  <a th:href="@{/favoritos}" class="btn btn-favorite ms-3">
					      <i class="bi bi-heart me-1"></i> Favoritos
					  </a>

			          <!-- Barra de pesquisa estilizada -->
			          <form class="d-flex ms-3 search-box" th:action="@{/buscar}" method="get">
			            <input class="form-control" type="search" placeholder="Buscar..." aria-label="Search" name="q">
			            <button class="btn btn-search" type="submit">
			              <i class="bi bi-search"></i>
			            </button>
			          </form>
					  <!-- Botão Sair -->
					  <a href="/logout" class="btn btn-logout ms-3">
					      <i class="bi bi-box-arrow-right me-1"></i> Sair
					  </a>
			        </div>
			      </div>
			    </nav>

    <div class="container my-5">
        <h2 class="text-center mb-4">Administração do Sistema</h2>

        <!-- Controle de Restaurantes -->
        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Restaurantes</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRestaurante">Adicionar Restaurante</button>
            </div>
            <table class="table table-striped table-hover bg-light rounded shadow-sm">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Horário</th>
                        <th>Culinária</th>
                        <th>Tipos de Prato</th>
						<th>Cidade</th>
                        <th>Endereço</th>
                        <th>Site</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Exemplo com Thymeleaf -->
                    <tr th:each="restaurante : ${restaurantes}">
                        <td th:text="${restaurante.nome}"></td>
                        <td th:text="${restaurante.horario}"></td>
                        <td th:text="${restaurante.culinaria}"></td>
                        <td th:text="${restaurante.tipodeprato}"></td>
						<td th:text="${restaurante.cidade}"></td>
                        <td th:text="${restaurante.endereco}"></td>
						<td>
						  <a th:if="${restaurante.site != null}" th:href="${restaurante.site}" target="_blank">Site</a>
						  <span th:if="${restaurante.site == null}">-</span>
						</td>
						<td>
						    <button type="button" class="btn btn-sm btn-warning"
						            data-bs-toggle="modal"
						            data-bs-target="#modalRestaurante"
						            th:attr="data-bs-id=${restaurante.id}, 
						                     data-bs-nome=${restaurante.nome},
						                     data-bs-horario=${restaurante.horario},
						                     data-bs-culinaria=${restaurante.culinaria},
						                     data-bs-cidade=${restaurante.cidade},
						                     data-bs-tipodeprato=${restaurante.tipodeprato},
						                     data-bs-endereco=${restaurante.endereco},
						                     data-bs-site=${restaurante.site}">
						        Editar
						    </button>

						    <form th:action="@{/adm/restauranteExcluir}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este restaurante?');">
						        <input type="hidden" name="id" th:value="${restaurante.id}">
						        <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
						    </form>
						</td>
                    </tr>
                </tbody>
            </table>
        </section>

		<!-- Controle de Usuários -->
		<table class="table table-hover align-middle">
		    
		    <thead class="table-light">
		        <tr>
		            <th>Nome</th>
		            <th>Email</th>
		            <th>Endereço</th>
		            <th class="text-center">Admin</th>
		            <th class="text-center">Ações</th> </tr>
		    </thead>
		    
		    <tbody>
		        <tr th:each="user : ${usuarios}">
		            
		            <form th:action="@{/adm/updateUser}" method="post" style="display: contents;">
		                
		                <input type="hidden" name="id" th:value="${user.idUsuario}">

		                <td>
		                    <input type="text" class="form-control form-control-sm" name="nome"
		                           th:value="${user.nomeUsuario}" placeholder="Nome" required>
		                </td>

		                <td>
		                    <input type="email" class="form-control form-control-sm" name="email"
		                           th:value="${user.emailUsuario}" placeholder="Email" required>
		                </td>
		                
		                <td>
		                    <input type="text" class="form-control form-control-sm" name="endereco"
		                           th:value="${user.enderecoUsuario}" placeholder="CEP">
		                </td>

		                <td class="text-center">
		                    <input class="form-check-input" type="checkbox" name="admin"
		                           th:checked="${user.role.name() == 'ROLE_ADMIN'}"
		                           th:disabled="${user.role.name() == 'ROLE_ADMIN' and totalAdmins == 1}">
		                </td>

		                <td class="text-center d-flex justify-content-center gap-2">
		                    
		                    <button type="submit" class="btn btn-sm btn-primary">Salvar</button>
		                    
		                    <form th:action="@{/adm/deleteUser}" method="post" class="d-inline"
		                          th:onsubmit="return confirmExcluir('[[${user.role.name()}]]', [[${totalAdmins}]])">
		                        <input type="hidden" name="id" th:value="${user.idUsuario}">
		                        <button type="submit" class="btn btn-sm btn-danger"
		                                th:disabled="${user.role.name() == 'ROLE_ADMIN' and totalAdmins == 1}">
		                            Excluir
		                        </button>
		                    </form>
		                </td>
		                
		            </form> </tr>
		    </tbody>
		</table>

		<script>
		function confirmExcluir(role, totalAdmins) {
		    if(role === 'ADMIN' && totalAdmins === 1){
		        alert("Não é possível excluir o único usuário admin!");
		        return false;
		    }
		    return confirm("Tem certeza que deseja excluir este usuário?");
		}
		</script>
    </div>

    <!-- Modal Restaurante -->
	
	  <div class="modal fade" id="modalRestaurante" tabindex="-1">
	    <div class="modal-dialog">
	      <div class="modal-content">
			<form id="formRestaurante" method="post" action="/adm/restauranteCadastrar">
			    <input type="hidden" name="id" id="modalRestauranteId">

			    <div class="modal-header">
			      <h5 class="modal-title" id="modalRestauranteTitle" style="color: black;">Adicionar Restaurante</h5>
			      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			    </div>
			    
				<div class="modal-body">
				    <input class="form-control mb-2" type="text" name="nome" id="modalRestauranteNome" placeholder="Nome" required>
				    <input class="form-control mb-2" type="text" name="horario" id="modalRestauranteHorario" placeholder="Horário de funcionamento" required>
					<label class="form-label" style="color: black;">Culinária:</label>
					<div class="input-group mb-2">
					    
					    <select class="form-select" id="selectCulinaria" onchange="atualizarCampoCulinaria()">
					        <option value="" selected disabled>Selecione uma culinária existente...</option>
					        
					        <option th:each="culinariaExistente : ${culinariasUnicas}" 
					                th:value="${culinariaExistente}" 
					                th:text="${culinariaExistente}">
					        </option>
					        
					        <option value="NOVA_CULINARIA">-- Nova Categoria --</option>
					    </select>
					    
					</div>

					<input class="form-control mb-2" type="text" id="inputNovaCulinaria" onkeyup="atualizarCampoCulinaria()"
					       placeholder="Digite o nome da nova culinária (ex: Coreana)" style="display: none;">


					<input type="hidden" name="culinaria" id="modalRestauranteCulinaria" required>
				    <div class="mb-2">
				      <label class="form-label" style="color: black;">Tipos de prato:</label><br>
				      <div class="form-check form-check-inline">
				          <input class="form-check-input" type="checkbox" name="tipodeprato" id="checkRodizio" value="Rodízio">
				          <label class="form-check-label" for="checkRodizio" style="color: orange;">Rodízio</label>
				      </div>
					  <div class="form-check form-check-inline">
					  	<input class="form-check-input" type="checkbox" name="tipodeprato" id="checkSelfService" value="Self Service">
					  	<label class="form-check-label" for="checkSelfService" style="color: orange;">Self Service</label>
					  </div>
				      <div class="form-check form-check-inline">
				          <input class="form-check-input" type="checkbox" name="tipodeprato" id="checkAlacarte" value="A la Carte">
				          <label class="form-check-label" for="checkAlacarte" style="color: orange;">A la Carte</label>
				      </div>
				    </div>

				    <hr>
				    
				    <label class="form-label" style="color: black;">Endereço:</label>
				    
				    <input class="form-control mb-2" type="text" id="cep" placeholder="CEP (só números)" onblur="buscarCEP(this.value)">

				    <div class="row g-2 mb-2">
				        <div class="col-md-9">
				            <input class="form-control" type="text" id="rua" placeholder="Rua / Logradouro" readonly>
				        </div>
				        <div class="col-md-3">
				            <input class="form-control" type="text" id="numero" placeholder="Número" required>
				        </div>
				    </div>
				    
				    <div class="row g-2 mb-2">
				        <div class="col-md-6">
				            <input class="form-control" type="text" id="bairro" placeholder="Bairro" readonly>
				        </div>
				        <div class="col-md-6">
				            <input class="form-control" type="text" name="cidade" id="modalRestauranteCidade" placeholder="Cidade" readonly>
				        </div>
				    </div>
				    
				    <input type="hidden" name="endereco" id="modalRestauranteEndereco">
				    
				    <hr>
				    
				    <input class="form-control mb-2" type="url" name="site" id="modalRestauranteSite" placeholder="Site (ex: https://www.site.com)">
				    <button class="btn btn-primary w-100" type="submit">Salvar</button>
				</div>
				
			</form> </div>
	    </div>
	  </div>
	
	  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	      
	  <script>
	      
	  // --- FUNÇÃO 1: BUSCAR O CEP (ViaCEP API) ---
	  // (Esta função está correta, sem mudanças)
	  function buscarCEP(valor) {
	      const cep = valor.replace(/\D/g, '');
	      if (cep.length === 8) {
	          document.getElementById('rua').value = "...";
	          document.getElementById('bairro').value = "...";
	          document.getElementById('modalRestauranteCidade').value = "...";
	          fetch(`https://viacep.com.br/ws/${cep}/json/`)
	              .then(response => response.json())
	              .then(data => {
	                  if (data.erro) {
	                      alert("CEP não encontrado.");
	                      limparFormularioCEP(true); // Limpa mantendo a cidade
	                  } else {
	                      document.getElementById('rua').value = data.logradouro;
	                      document.getElementById('bairro').value = data.bairro;
	                      document.getElementById('modalRestauranteCidade').value = data.localidade;
	                      document.getElementById('numero').focus();
	                  }
	              })
	              .catch(error => {
	                  alert("Erro ao buscar CEP. Tente novamente.");
	                  limparFormularioCEP(true); // Limpa mantendo a cidade
	              });
	      } else if (cep.length > 0) {
	          alert("CEP inválido. Deve conter 8 números.");
	          limparFormularioCEP(true);
	      }
	  }

	  function limparFormularioCEP(manterCidade = false) {
	      document.getElementById('rua').value = "";
	      document.getElementById('bairro').value = "";
	      if (!manterCidade) {
	          document.getElementById('modalRestauranteCidade').value = "";
	      }
	  }

	  // --- FUNÇÃO 2: PREENCHER O ENDEREÇO COMPLETO ---
	  // (Esta função está correta, sem mudanças)
	  const formRestaurante = document.getElementById('formRestaurante');
	  formRestaurante.addEventListener('submit', function(event) {
	      const cep = document.getElementById('cep').value;
	      if (cep.length > 0) {
	          const rua = document.getElementById('rua').value;
	          const numero = document.getElementById('numero').value;
	          const bairro = document.getElementById('bairro').value;
	          const enderecoCompleto = `${rua}, ${numero} - ${bairro}`;
	          document.getElementById('modalRestauranteEndereco').value = enderecoCompleto;
	      }
	  });

	  // --- FUNÇÃO 3: CONTROLE DO MENU SUSPENSO DE CULINÁRIA ---
	  // (Esta função está correta, sem mudanças)
	  function atualizarCampoCulinaria() {
	      const select = document.getElementById('selectCulinaria');
	      const inputNova = document.getElementById('inputNovaCulinaria');
	      const campoEscondido = document.getElementById('modalRestauranteCulinaria');

	      if (select.value === 'NOVA_CULINARIA') {
	          inputNova.style.display = 'block';
	          inputNova.focus();
	          // **CORREÇÃO DE BUGZINHO AQUI**: Atualiza o hidden conforme digita
	          inputNova.onkeyup = () => { campoEscondido.value = inputNova.value; };
	          
	      } else {
	          inputNova.style.display = 'none';
	          inputNova.value = '';
	          campoEscondido.value = select.value;
	      }
	  }

	  // --- FUNÇÃO 4: JAVASCRIPT DO MODAL (A GRANDE CORREÇÃO) ---
	  const modalRestaurante = document.getElementById('modalRestaurante');
	  modalRestaurante.addEventListener('show.bs.modal', event => {
	      
	      const button = event.relatedTarget;
	      const form = document.getElementById('formRestaurante');
	      const title = document.getElementById('modalRestauranteTitle');
	      
	      // Pega os dados do botão
	      const id = button.getAttribute('data-bs-id');
	      
	      // Pega os elementos do formulário
	      const inputId = document.getElementById('modalRestauranteId');
	      const inputNome = document.getElementById('modalRestauranteNome');
	      const inputHorario = document.getElementById('modalRestauranteHorario');
	      const inputSite = document.getElementById('modalRestauranteSite');
	      const selectCulinaria = document.getElementById('selectCulinaria');
	      const inputNovaCulinaria = document.getElementById('inputNovaCulinaria');
	      const campoEscondidoCulinaria = document.getElementById('modalRestauranteCulinaria');
	      const inputCidade = document.getElementById('modalRestauranteCidade');
	      const inputEnderecoHidden = document.getElementById('modalRestauranteEndereco');
	      const checkRodizio = document.getElementById('checkRodizio');
	      const checkSelfService = document.getElementById('checkSelfService');
	      const checkAlacarte = document.getElementById('checkAlacarte');

	      // **A CORREÇÃO:** Limpa os campos de CEP/Rua/Bairro
	      // (Movido daqui de fora para dentro do "else" (Modo Adicionar))

	      if (id) {
	          // --- MODO EDIÇÃO ---
	          title.textContent = 'Editar Restaurante';
	          form.action = '/adm/restauranteEditar';

	          // Pega os dados do botão
	          const nome = button.getAttribute('data-bs-nome');
	          const horario = button.getAttribute('data-bs-horario');
	          const culinaria = button.getAttribute('data-bs-culinaria');
	          const cidade = button.getAttribute('data-bs-cidade');
	          const tipodeprato = button.getAttribute('data-bs-tipodeprato');
	          const endereco = button.getAttribute('data-bs-endereco');
	          const site = button.getAttribute('data-bs-site'); // <-- Vai ser 'null' se não existir

	          // Preenche TODOS os campos
	          inputId.value = id;
	          inputNome.value = nome;
	          inputHorario.value = horario;
	          inputCidade.value = cidade;
	          inputEnderecoHidden.value = endereco; // Seta o hidden (para o submit)
	          inputSite.value = site || ''; // Seta o site (ou string vazia se for nulo)

	          // Preenche a Culinária
	          campoEscondidoCulinaria.value = culinaria; // Seta o hidden (para o submit)
	          selectCulinaria.value = culinaria; // Seta o <select>
	          inputNovaCulinaria.style.display = 'none';
	          inputNovaCulinaria.value = '';

	          // Preenche os Checkboxes
	          checkRodizio.checked = (tipodeprato && tipodeprato.includes('Rodízio'));
	          checkSelfService.checked = (tipodeprato && tipodeprato.includes('Self Service'));
	          checkAlacarte.checked = (tipodeprato && tipodeprato.includes('A la Carte'));
	          
	          // Limpa os campos do CEP (pois no modo edição eles são opcionais)
	          document.getElementById('cep').value = "";
	          document.getElementById('rua').value = "";
	          document.getElementById('numero').value = "";
	          document.getElementById('bairro').value = "";
	          
	          // Coloca placeholders para mostrar o endereço antigo
	          document.getElementById('cep').placeholder = "Digite um NOVO CEP para alterar o endereço";
	          document.getElementById('rua').placeholder = "Endereço atual: " + endereco;

	      } else {
	          // --- MODO ADICIONAR ---
	          title.textContent = 'Adicionar Restaurante';
	          form.action = '/adm/restauranteCadastrar'; 
	          
	          // form.reset() limpa todos os campos visíveis
	          form.reset(); 
	          
	          // Garante que os campos hidden e de estado sejam limpos
	          inputId.value = ''; 
	          campoEscondidoCulinaria.value = ''; 
	          inputEnderecoHidden.value = ''; 
	          inputNovaCulinaria.style.display = 'none';
	          selectCulinaria.value = '';
	          
	          // Limpa os placeholders (caso tenham sido alterados pelo modo Edição)
	          document.getElementById('cep').placeholder = "CEP (só números)";
	          document.getElementById('rua').placeholder = "Rua / Logradouro";
	      }
	  });
	  </script>
	      
	  </body>
	  </html>