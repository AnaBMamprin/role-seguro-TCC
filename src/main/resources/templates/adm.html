<!DOCTYPE html>
<html lang="pt-BR" 
	xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCHOMP Administração</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<nav class="navbar navbar-expand-lg main-navbar">
	  <div class="container-fluid">
		<a class="navbar-brand text-white fw-bold" href="/inicial">TCHOMP</a>
		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
		  <span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse justify-content-center" id="navbarMain">
		  <div class="navbar-nav mx-auto d-flex justify-content-center">
			<a class="nav-link" th:href="@{/inicial}">Página Inicial</a>
			<a class="nav-link" th:href="@{/restaurantes}">Restaurantes</a>
			<a class="nav-link" th:href="@{/perfil}">Perfil</a>
			<a class="nav-link" th:href="@{/adm}" sec:authorize="hasRole('ADMIN')">Administração</a>
			<a class="nav-link" th:href="@{/sobre}">Sobre</a>
		  </div>
		  <a th:href="@{/favoritos}" class="btn btn-favorite ms-3">
			  <i class="bi bi-heart me-1"></i> Favoritos
		  </a>
		  <form class="d-flex ms-3 search-box" th:action="@{/buscar}" method="get">
			<input class="form-control" type="search" placeholder="Buscar..." aria-label="Search" name="q">
			<button class="btn btn-search" type="submit">
			  <i class="bi bi-search"></i>
			</button>
		  </form>
		  <a href="/logout" class="btn btn-logout ms-3">
			  <i class="bi bi-box-arrow-right me-1"></i> Sair
		  </a>
		</div>
	  </div>
	</nav>

    <div class="container my-5">
        <h2 class="text-center mb-4">Administração do Sistema</h2>
        
        <div th:if="${sucesso}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${sucesso}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${erro}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Restaurantes</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRestaurante">Adicionar Restaurante</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover bg-light rounded shadow-sm">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Horário</th>
                            <th>Culinária</th>
                            <th>Tipos de Prato</th>
                            <th>Cidade</th>
                            <th>Endereço</th>
                            <th>Site</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="restaurante : ${restaurantes}">
                            <td th:text="${restaurante.nome}"></td>
                            <td th:text="${restaurante.horario}"></td>
                            <td th:text="${restaurante.culinaria}"></td>
                            <td th:text="${restaurante.tipodeprato}"></td>
                            <td th:text="${restaurante.cidade}"></td>
                            <td th:text="${restaurante.endereco}"></td>
                            <td>
                              <a th:if="${restaurante.site != null}" th:href="${restaurante.site}" target="_blank">Site</a>
                              <span th:if="${restaurante.site == null}">-</span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-warning"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalRestaurante"
                                        th:attr="data-bs-id=${restaurante.id}, 
                                                 data-bs-nome=${restaurante.nome},
                                                 data-bs-horario=${restaurante.horario},
                                                 data-bs-culinaria=${restaurante.culinaria},
                                                 data-bs-cidade=${restaurante.cidade},
                                                 data-bs-tipodeprato=${restaurante.tipodeprato},
                                                 data-bs-endereco=${restaurante.endereco},
                                                 data-bs-site=${restaurante.site}">
                                    Editar
                                </button>

                                <form th:action="@{/adm/restauranteExcluir}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este restaurante?');">
                                    <input type="hidden" name="id" th:value="${restaurante.id}">
                                    <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="mb-5">
            <h3>Usuários</h3>
            <div class="table-responsive">
                <table class="table table-hover align-middle bg-light rounded shadow-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Endereço</th>
                            <th class="text-center">Cargo</th>
                            <th class="text-center">Ações</th> 
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="user : ${usuarios}">
                            <form th:action="@{/adm/updateUser}" method="post">
                                <input type="hidden" name="id" th:value="${user.idUsuario}">
                                <td>
                                    <input type="text" class="form-control form-control-sm" name="nome"
                                           th:value="${user.nomeUsuario}" placeholder="Nome" required>
                                </td>
                                <td>
                                    <input type="email" class="form-control form-control-sm" name="email"
                                           th:value="${user.emailUsuario}" placeholder="Email" required>
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" name="endereco"
                                           th:value="${user.enderecoUsuario}" placeholder="CEP">
                                </td>
                                <td class="text-center">
                                    <select class="form-select form-select-sm" name="role" 
                                        th:disabled="${user.role.name() == 'ROLE_ADMIN' and totalAdmins == 1}">
                                        <option value="ROLE_USER" th:selected="${user.role.name() == 'ROLE_USER'}">Cliente</option>
                                        <option value="ROLE_RESTAURANTE" th:selected="${user.role.name() == 'ROLE_RESTAURANTE'}">Restaurante</option>
                                        <option value="ROLE_ADMIN" th:selected="${user.role.name() == 'ROLE_ADMIN'}">Admin</option>
                                    </select>
                                </td>
                                <td class="text-center d-flex justify-content-center gap-2">
                                    <button type="submit" class="btn btn-sm btn-primary">Salvar</button>
                                    <button type="submit" class="btn btn-sm btn-danger"
                                            th:formaction="@{/adm/deleteUser}"
                                            th:disabled="${user.role.name() == 'ROLE_ADMIN' and totalAdmins == 1}"
                                            onclick="return confirmExcluir('[[${user.role.name()}]]', '[[${totalAdmins}]]')">
                                        Excluir
                                    </button>
                                </td>
                            </form> 
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div> 
    <div class="modal fade" id="modalRestaurante" tabindex="-1">
        <div class="modal-dialog">
		      <div class="modal-content">
	            
	            <form id="formRestaurante" method="post" action="/adm/restauranteCadastrar" enctype="multipart/form-data">
	                
	                <input type="hidden" name="id" id="modalRestauranteId">
	                <div class="modal-header">
				      <h5 class="modal-title" id="modalRestauranteTitle" style="color: black;">Adicionar Restaurante</h5>
				      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				    </div>
				    
					<div class="modal-body">			

					    <input class="form-control mb-2" type="text" name="nome" id="modalRestauranteNome" placeholder="Nome" required>
					    <input class="form-control mb-2" type="text" name="horario" id="modalRestauranteHorario" placeholder="Horário de funcionamento" required>
						
	                    <label class="form-label" style="color: black;">Culinária:</label>
						<div class="input-group mb-2">
						    <select class="form-select" id="selectCulinaria" onchange="atualizarCampoCulinaria()">
						        <option value="" selected disabled>Selecione uma culinária existente...</option>
						        <option th:each="culinariaExistente : ${culinariasUnicas}" 
						                th:value="${culinariaExistente}" 
						                th:text="${culinariaExistente}">
						        </option>
						        <option value="NOVA_CULINARIA">-- Nova Categoria --</option>
						    </select>
						</div>
						<input class="form-control mb-2" type="text" id="inputNovaCulinaria" onkeyup="atualizarCampoCulinaria()"
						       placeholder="Digite o nome da nova culinária (ex: Coreana)" style="display: none;">
						<input type="hidden" name="culinaria" id="modalRestauranteCulinaria" required>

					    <div class="mb-2">
					      <label class="form-label" style="color: black;">Tipos de prato:</label><br>
					      <div class="form-check form-check-inline">
					          <input class="form-check-input" type="checkbox" name="tipodeprato" id="checkRodizio" value="Rodízio">
					          <label class="form-check-label" for="checkRodizio" style="color: orange;">Rodízio</label>
					      </div>
						  <div class="form-check form-check-inline">
						  	<input class="form-check-input" type="checkbox" name="tipodeprato" id="checkSelfService" value="Self Service">
						  	<label class="form-check-label" for="checkSelfService" style="color: orange;">Self Service</label>
						  </div>
					      <div class="form-check form-check-inline">
					          <input class="form-check-input" type="checkbox" name="tipodeprato" id="checkAlacarte" value="A la Carte">
					          <label class="form-check-label" for="checkAlacarte" style="color: orange;">A la Carte</label>
					      </div>
					    </div>

					    <hr>
					    
					    <label class="form-label" style="color: black;">Endereço:</label>
					    
	                    <input class="form-control mb-2" type="text" id="cep" placeholder="CEP (só números)" onblur="buscarCEP(this.value)">

						<div class="row g-2 mb-2">
						    <div class="col-md-9">
						        <input class="form-control" type="text" id="rua" name="rua" 
						               placeholder="Rua / Logradouro" readonly>
						    </div>
						    <div class="col-md-3">
						        <input class="form-control" type="text" id="numero" name="numero" 
						               placeholder="Número" required>
						    </div>
						</div>

						<div class="row g-2 mb-2">
						    <div class="col-md-6">
						        <input class="form-control" type="text" id="bairro" name="bairro" 
						               placeholder="Bairro" readonly>
						    </div>
						    <div class="col-md-6">
						        <input class="form-control" type="text" name="cidade" 
						               id="modalRestauranteCidade" placeholder="Cidade" readonly>
						    </div>
						</div>

	                    <input type="hidden" id="estado" name="estado">
					    
					    <hr>
					    
					    <input class="form-control mb-2" type="url" name="site" id="modalRestauranteSite" placeholder="Site (ex: https://www.site.com)">
						
	                    <hr>
	                    
						<div class="mb-3">
						    <label for="fotoFile" class="form-label" style="color: black;">Foto Principal</label>
						    <input class="form-control" type="file" id="fotoFile" name="fotoFile" accept="image/png, image/jpeg, image/webp">
						    <small class="form-text text-muted" style="color: black !important;">
						        Ao editar, a foto atual será mantida se nenhum novo arquivo for enviado.
						    </small>
						</div>
					</div>

	                <div class="modal-footer">
					    <button class="btn btn-primary w-100" type="submit">Salvar</button>
	                </div>
					
				</form> </div>
		    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
		function confirmExcluir(role, totalAdmins) {
		    if(role === 'ROLE_ADMIN' && totalAdmins === 1){
		        alert("Não é possível excluir o único usuário admin!");
		        return false;
		    }
		    return confirm("Tem certeza que deseja excluir este usuário?");
		}

		function buscarCEP(valor) {
		      const cep = valor.replace(/\D/g, '');
		      if (cep.length === 8) {
		          document.getElementById('rua').value = "...";
		          document.getElementById('bairro').value = "...";
		          document.getElementById('modalRestauranteCidade').value = "...";
		          document.getElementById('estado').value = "...";
		          
		          fetch(`https://viacep.com.br/ws/${cep}/json/`)
		              .then(response => response.json())
		              .then(data => {
		                  if (data.erro) {
		                      alert("CEP não encontrado.");
		                      limparFormularioCEP(true); 
		                  } else {
		                      document.getElementById('rua').value = data.logradouro;
		                      document.getElementById('bairro').value = data.bairro;
		                      document.getElementById('modalRestauranteCidade').value = data.localidade;
		                      document.getElementById('estado').value = data.uf;
		                      document.getElementById('numero').focus();
		                  }
		              })
		              .catch(error => {
		                  alert("Erro ao buscar CEP. Tente novamente.");
		                  limparFormularioCEP(true);
		              });
		      } else if (cep.length > 0) {
		          alert("CEP inválido. Deve conter 8 números.");
		          limparFormularioCEP(true);
		      }
		  }

		  function limparFormularioCEP(manterCidade = false) {
		      document.getElementById('rua').value = "";
		      document.getElementById('bairro').value = "";
		      document.getElementById('estado').value = "";
		      if (!manterCidade) {
		          document.getElementById('modalRestauranteCidade').value = "";
		      }
		  }

		  function atualizarCampoCulinaria() {
		      const select = document.getElementById('selectCulinaria');
		      const inputNova = document.getElementById('inputNovaCulinaria');
		      const campoEscondido = document.getElementById('modalRestauranteCulinaria');

		      if (select.value === 'NOVA_CULINARIA') {
			          inputNova.style.display = 'block';
			          inputNova.focus();
			          inputNova.onkeyup = () => { campoEscondido.value = inputNova.value; };
			          
			      } else {
			          inputNova.style.display = 'none';
			          inputNova.value = '';
			          campoEscondido.value = select.value;
			      }
			  }

			  const modalRestaurante = document.getElementById('modalRestaurante');
			  modalRestaurante.addEventListener('show.bs.modal', event => {
			      
			      const button = event.relatedTarget;
			      const form = document.getElementById('formRestaurante');
			      const title = document.getElementById('modalRestauranteTitle');
			      
			      const id = button.getAttribute('data-bs-id');
			      
			      const inputId = document.getElementById('modalRestauranteId');
			      const inputNome = document.getElementById('modalRestauranteNome');
			      const inputHorario = document.getElementById('modalRestauranteHorario');
			      const inputSite = document.getElementById('modalRestauranteSite');
			      const selectCulinaria = document.getElementById('selectCulinaria');
			      const inputNovaCulinaria = document.getElementById('inputNovaCulinaria');
			      const campoEscondidoCulinaria = document.getElementById('modalRestauranteCulinaria');
			      const inputCidade = document.getElementById('modalRestauranteCidade');
			      const checkRodizio = document.getElementById('checkRodizio');
			      const checkSelfService = document.getElementById('checkSelfService');
			      const checkAlacarte = document.getElementById('checkAlacarte');

			      if (id) {

			          title.textContent = 'Editar Restaurante';
			          form.action = '/adm/restauranteEditar';

			          const nome = button.getAttribute('data-bs-nome');
			          const horario = button.getAttribute('data-bs-horario');
			          const culinaria = button.getAttribute('data-bs-culinaria');
			          const cidade = button.getAttribute('data-bs-cidade');
			          const tipodeprato = button.getAttribute('data-bs-tipodeprato');
			          const endereco = button.getAttribute('data-bs-endereco');
			          const site = button.getAttribute('data-bs-site');

			          inputId.value = id;
			          inputNome.value = nome;
			          inputHorario.value = horario;
			          inputCidade.value = cidade;
			          inputSite.value = site || ''; 

			          campoEscondidoCulinaria.value = culinaria; 
			          selectCulinaria.value = culinaria; 
			          inputNovaCulinaria.style.display = 'none';
			          inputNovaCulinaria.value = '';

			          checkRodizio.checked = (tipodeprato && tipodeprato.includes('Rodízio'));
			          checkSelfService.checked = (tipodeprato && tipodeprato.includes('Self Service'));
			          checkAlacarte.checked = (tipodeprato && tipodeprato.includes('A la Carte'));

			          document.getElementById('cep').value = "";
			          document.getElementById('rua').value = "";
			          document.getElementById('numero').value = "";
			          document.getElementById('bairro').value = "";
			          document.getElementById('estado').value = ""; 
			          
			          document.getElementById('cep').placeholder = "Digite um NOVO CEP para alterar o endereço";
			          document.getElementById('rua').placeholder = "Endereço atual: " + endereco; 

			      } else {
			          title.textContent = 'Adicionar Restaurante';
			          form.action = '/adm/restauranteCadastrar'; 
			          
			          form.reset(); 

			          inputId.value = ''; 
			          campoEscondidoCulinaria.value = ''; 
			          inputNovaCulinaria.style.display = 'none';
			          selectCulinaria.value = '';
			          document.getElementById('estado').value = ''; 
			          
			          document.getElementById('cep').placeholder = "CEP (só números)";
			          document.getElementById('rua').placeholder = "Rua / Logradouro";
			      }
			  });
			  </script>
</body>
</html>